---
title: "Untitled"
author: "Brendan F. Miller"
date: "3/23/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# MOB

```{r}

# for assessing beta values
save(mob_se_wt, # processed data matrix for 17709 wt cells and 18560 genes (filtered genes during the processing)
     mob_se_wt_obj, # seurat object of the processed data and meta data
     mob_se_wt_raw, # raw counts of the 17709 wt cells and 18560 genes
     mob_se_wt_raw_obj_sct, # seurat object of raw data, and also my own SCT processing (but turned out different than the supplied data)
     cluster_markers_mob_se_wt, # Seurat::FindAllMarkers for the processed wt cells and 38 clusters
     cluster_markers_mob_se_wt_raw, # Seurat::FindAllMarkers for the raw counts wt cells and 38 clusters
     mobWtCellProxyBeta, # averaged relative counts for the 38 clusters for 18560 genes by averaging the processed log-norm data
     mobWtCellProxyBetaRaw, # averaged relative counts for the 38 clusters for 18560 genes by averaging the raw counts
     mob_k15, # LDA model of the mob data with k=15 and 93 common OD genes across the 12 MOB samples
     sl_countsClean, # SL model trained on `mob_se_wt_obj` and `countsClean` ST data of the `mOB` data (260 spots and 6336 shared genes)
     sl_ctTheta, # thetaCt of the above model, but Mural2 removed because 0 in all spots
     W_countsClean, # betaTopics of the sl_countsClean; the W matrix of the NMF fitted model
     file = "/Users/brendan/Desktop/PostDoc/work/STDeconvolve/repos/STdeconvolve/data/mob_data_to_assess_beta.RData")

load("/Users/brendan/Desktop/PostDoc/work/STDeconvolve/repos/STdeconvolve/data/mob_data_to_assess_beta.RData")
RCTD_mob_results_norm <- readRDS("/Users/brendan/Desktop/PostDoc/work/STDeconvolve/repos/STdeconvolve/data/RCTD_mob_results_norm.Rds")

countsClean <- readRDS("/Users/brendan/Desktop/PostDoc/work/STDeconvolve/repos/STdeconvolve/data/countsClean.Rds")
# 260 x 7365 cleaned raw counts ST count matrix for the mOB dataset for which the mob_k15 was trained on

mobCorpus <- readRDS("/Users/brendan/Desktop/PostDoc/work/STDeconvolve/repos/STdeconvolve/data/mobCorpus.Rds")
# corpus of all the mob datasets and also has the spot positions

```

```{r}

fig_path <- "/Users/brendan/Desktop/PostDoc/work/STDeconvolve/repos/STdeconvolve/figures/"

```

Thought:
Reselect genes for corpus based on genes that are significantly spatially heterogeneous?

MERIGNUE differential genes for each cluster:
```{r}

# cells and their associated clusters
mobWtCellClusters <- mob_se_wt_obj$ClusterName

difGenes <- MERINGUE::getDifferentialGenes(cd = mob_se_wt, cols = mobWtCellClusters)
difGenesRaw <- MERINGUE::getDifferentialGenes(cd = mob_se_wt_raw, cols = mobWtCellClusters)

# NOTE: because each genes is assessed separately, it is ok that all the 18K genes are being used instead of limiting to the 93 just for this analysis
                                            
```

Explore the correspondence between beta values for MOB topics and the gene counts for mob cell types from a scRNAseq reference.

It is possible that because the LDA was trained on a different ST dataset, there might not be perfect or high correspondence, but hopefully there will be some relationship that could be used to filter for genes in the beta matrix that could be used to annotate the topics.

## Beta Pairing

```{r}

m1 <- mob_k15$beta
m2 <- as.matrix(mobWtCellProxyBetaRaw)

sharedGenes <- intersect(colnames(m1), colnames(m2))

betaCor <- getCorrMtx(m1 = m1,
                      m2 = m2, # gt proxy beta
                      type = "b")

gplots::heatmap.2(x = betaCor,
                  # Rowv = NA, # to order topics based on pairs and not dendrogram
                  # Colv = NA,
                  density.info = "none",
                  trace = "none",
                  col = correlation_palette,
                  breaks = correlation_breaks,
                  key.xlab = "Correlation",
                  # xlab = "Predicted topics",
                  # ylab = "Major cell class",
                  key.title = NA,
                  cexRow = 1,
                  cexCol = 0.9,
                  # lhei = c(1,3),
                  margins = c(6,4))

pairs <- lsatPairs(betaCor)
gplots::heatmap.2(x = betaCor[pairs$rowix, pairs$colsix],
                  Rowv = NA, # to order topics based on pairs and not dendrogram
                  Colv = NA,
                  density.info = "none",
                  trace = "none",
                  col = correlation_palette,
                  breaks = correlation_breaks,
                  key.xlab = "Correlation",
                  # xlab = "Predicted topics",
                  # ylab = "Major cell class",
                  key.title = NA,
                  cexRow = 1,
                  cexCol = 0.9,
                  # lhei = c(1,3),
                  margins = c(6,4))

diag_cors <- diag(betaCor[pairs$rowix, pairs$colsix])

hist(diag_cors, breaks = 10)
mean(diag_cors)
sd(diag_cors)

```

```{r}

m1 <- mob_k15$beta
m2 <- as.matrix(mobWtCellProxyBetaRaw)

sharedGenes <- intersect(colnames(m1), colnames(m2))

corMtx <- getCorrMtx(m1 = m1,
                      m2 = m2,
                      type = "b")
pairs <- lsatPairs(corMtx)

summary_df <- do.call(rbind, lapply(pairs$rowix, function(i){
        # get paired ct
        ct <- rownames(m2)[pairs$colsix[i]]
        
        # the corresponding diff genes table
        ct_df <- difGenesRaw[[ct]]
        
        # filter for sig diff genes for specific ct
        # ct_df <- ct_df[ct_df$p.adj < 0.05,]
        
        # ct sig genes that are also in corpus
        genes <- intersect(sharedGenes, rownames(ct_df))
        
        topic_betas <- m1[i,genes]
        ct_df <- ct_df[genes,]
        
        # gexp values
        ct_genes <- m2[ct,genes]
        
        # add extra columns to df for ggplot
        ct_df$gexp <- ct_genes
        ct_df$gexp_rank <- rank(ct_genes)
        ct_df$beta <- topic_betas
        ct_df$beta_rank <- rank(topic_betas) # 1 = lowest beta
        ct_df$pair <- paste0(i, " vs ", ct)
        
        # take top 10 betas
        # ct_df <- ct_df[ct_df$beta_rank > 83,]
         
        # x <- -log10(ct_df$p.adj)
        # x <- log10(ct_df$gexp + 1)
        x <- ct_df$gexp
        # y <- ct_df$beta
        y <- ct_df$beta_rank
        # y <- ct_df$beta
         
        prsn <- cor(x, y, method = "pearson")
        sprn <- cor(x, y, method = "spearman")
        p <- ggplot(data = ct_df) +
                geom_point(aes(x = gexp, y = beta_rank)) +
                labs(title = paste("Beta pairs: Topic", i, "vs", ct, "; cor =", round(corMtx[i,ct],2), "\n",
                                   "pearson =", round(prsn, 2), "spearman =", round(sprn, 2)))
        print(p)
        ct_df
})) 

ggplot(data = summary_df) +
        geom_hex(aes(x = gexp_rank, y = beta_rank), bins=10) +
        scale_fill_gradient(low = "white", high = "red") +
        theme_classic()

# white to red or black
```

## Theta Pairing

```{r}

m1 <- mob_k15$theta
m2 <- as.matrix(RCTD_mob_results_norm)

sharedGenes <- intersect(colnames(m1), colnames(m2))

thetaCor <- getCorrMtx(m1 = m1,
                      m2 = m2, # gt proxy beta
                      type = "t")

gplots::heatmap.2(x = thetaCor,
                  # Rowv = NA, # to order topics based on pairs and not dendrogram
                  # Colv = NA,
                  density.info = "none",
                  trace = "none",
                  col = correlation_palette,
                  breaks = correlation_breaks,
                  key.xlab = "Correlation",
                  # xlab = "Predicted topics",
                  # ylab = "Major cell class",
                  key.title = NA,
                  cexRow = 1,
                  cexCol = 0.9,
                  # lhei = c(1,3),
                  margins = c(6,4))

pairs <- lsatPairs(thetaCor)
gplots::heatmap.2(x = thetaCor[pairs$rowix, pairs$colsix],
                  Rowv = NA, # to order topics based on pairs and not dendrogram
                  Colv = NA,
                  density.info = "none",
                  trace = "none",
                  col = correlation_palette,
                  breaks = correlation_breaks,
                  key.xlab = "Correlation",
                  # xlab = "Predicted topics",
                  # ylab = "Major cell class",
                  key.title = NA,
                  cexRow = 1,
                  cexCol = 0.9,
                  # lhei = c(1,3),
                  margins = c(6,4))

diag_cors <- diag(thetaCor[pairs$rowix, pairs$colsix])

hist(diag_cors, breaks = 10)
mean(diag_cors)
sd(diag_cors)


```

```{r}

m1 <- mob_k15$beta
m2 <- as.matrix(mobWtCellProxyBetaRaw)

sharedGenes <- intersect(colnames(m1), colnames(m2))

corMtx <- getCorrMtx(m1 =  mob_k15$theta,
                      m2 = as.matrix(RCTD_mob_results_norm),
                      type = "t")
pairs <- lsatPairs(corMtx)

summary_df <- do.call(rbind, lapply(pairs$rowix, function(i){
        # get paired ct
        ct <- colnames(as.matrix(RCTD_mob_results_norm))[pairs$colsix[i]]
        # ct <- rownames(m2)[pairs$colsix[i]]
        
        # the corresponding diff genes table
        ct_df <- difGenesRaw[[ct]]
        
        # filter for sig diff genes for specific ct
        # ct_df <- ct_df[ct_df$p.adj < 0.05,]
        
        # ct sig genes that are also in corpus
        genes <- intersect(sharedGenes, rownames(ct_df))
        
        topic_betas <- m1[i,genes]
        ct_df <- ct_df[genes,]
        
        # gexp values
        ct_genes <- m2[ct,genes]
        
        # add extra columns to df for ggplot
        ct_df$gexp <- ct_genes
        ct_df$gexp_rank <- rank(ct_genes)
        ct_df$beta <- topic_betas
        ct_df$beta_rank <- rank(topic_betas) # 1 = lowest beta
        ct_df$pair <- paste0(i, " vs ", ct)
        
        # take top 10 betas
        # ct_df <- ct_df[ct_df$beta_rank > 83,]
         
        # x <- -log10(ct_df$p.adj)
        # x <- log10(ct_df$gexp + 1)
        x <- ct_df$gexp
        # y <- ct_df$beta
        y <- ct_df$beta_rank
        # y <- ct_df$beta
         
        prsn <- cor(x, y, method = "pearson")
        sprn <- cor(x, y, method = "spearman")
        p <- ggplot(data = ct_df) +
                geom_point(aes(x = gexp, y = beta_rank)) +
                labs(title = paste("Beta pairs: Topic", i, "vs", ct, "; cor =", round(corMtx[i,ct],2), "\n",
                                   "pearson =", round(prsn, 2), "spearman =", round(sprn, 2)))
        print(p)
        ct_df
})) 

ggplot(data = summary_df) +
        geom_hex(aes(x = gexp_rank, y = beta_rank), bins=10) +
        scale_fill_gradient(low = "white", high = "red") +
        theme_classic()
# cor(summary_df$gexp_rank, summary_df$beta_rank, method = "pearson")

# ggplot(data = summary_df) +
#         geom_point(aes(x = log2(gexp + 1), y = beta_rank, color = pair))

```

## Selecting Betas

```{r}


ggplot(data = reshape2::melt(mob_k15$beta)) +
  geom_boxplot(aes(x = paste("Topic", Var1), y = value)) +
  labs(
       x = "Topic", y = "gene beta value") +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# ggplot(data = reshape2::melt(m1_filt)) +
#   geom_boxplot(aes(x = as.character(Var1), y = value)) +
#   geom_point(data = reshape2::melt(m1_filt)[which(reshape2::melt(m1_filt)[,"Var2"] == "Ptgds"),], 
#              aes(x = as.character(Var1), y = value, color = "red"))

```
*One idea to select:*
When reviewing a box plot, an outlier is defined as a data point that is located outside the whiskers of the box plot.
For example, outside 1.5 times the interquartile range above the upper quartile and below the lower quartile (Q1 - 1.5 * IQR or Q3 + 1.5 * IQR).


This is the distribution of beta values of the corpus genes for each topic. 
Idea is to select genes that are significantly higher than the distribution of beta values for a topic.

Another thought is whether the topic genes in a topic are distinct from the others or are there sets of genes that are enriched with high beta values for groups of topics? 

```{r}

# for each topic generate a PDF built off the gene betas for that topic.
# then for each gene, get it's p-val by integrating from the beta-value of the gene to the tail

topicGenePvals <- do.call(rbind, lapply(rownames(mob_k15$beta), function(t){
  PDF <- approxfun(density(mob_k15$beta[t,]), rule=2)
  plot(PDF)
  pvals <- unlist(lapply(colnames(mob_k15$beta), function(g){
    p <- integrate(PDF, lower=mob_k15$beta[t,g], upper=1, stop.on.error = FALSE)
    p$value
  }))
  names(pvals) <- colnames(mob_k15$beta)
  pvals
}))
rownames(topicGenePvals) <- rownames(mob_k15$beta)


```

see the relationship between the p-val and beta value for genes in each topic

```{r}

topicSigGenes <- lapply(rownames(mob_k15$beta), function(t) {
  plot(-log10(topicGenePvals[t,]), mob_k15$beta[t,])
  plot(rank(topicGenePvals[t,]), rank(mob_k15$beta[t,]))
  
  # print(-log10(topicGenePvals[t, which(-log10(topicGenePvals[t,]) > -log10(0.05))]))
  mob_k15$beta[t, which(-log10(topicGenePvals[t,]) > -log10(0.05))]
  
})

```

Rank is the same, but the p-value is not the same as the beta.

Selecting genes with p-vals < 0.05 yeilds approx 2-4 genes per topic that have the highest betas. Interestingly you do see some genes enriched for different groups of topics. It likely represents how the topics are related to each other in space and what cell layers and sub-layers they correspond to.

```{r}

table(names(unlist(topicSigGenes)))

```

Equally interesting to the more frequent genes are the genes that are unique for a topic significant genes

```{r}

for (topic in seq(length(topicSigGenes))){
        genes <- names(topicSigGenes[[topic]])
        df <- countsClean[,genes]
        df <- merge(mobCorpus$mob$pos, as.data.frame(df), by=0)
        rownames(df) <- df$Row.names
        
        for (gene in genes){
              vizGeneCounts(df = df,
              gene = gene,
              groups = NA,
              group_cols = NA,
              size = 7, stroke = 0.01,
              plotTitle = paste(topic, gene),
              showLegend = TRUE)
        }
        
}

```

# MERFISH

```{r}

# all of the trained models for merfish:
save(bregmaCellsGexpFN7, # 59651 cells in FN7 bregmas x 125 gene counts (blanks removed and ambiguous cells removed)
      bregmaCellsGexpFN7_filt, # above but only cells kept in simulated patches (49142)
      gtCtGenesFN7, # reference for 8 major cell types and 125 genes. relative average expression. Used all 59651 cells
      gtCtNeuronalGenesFN7, # same as above but expanded into neuronal cts so 75 types
      FN7, # hash table storing each simulated bregma in FN7. Built such that cellTypeTable is for 8 major cts
      FN7_neuro, # same as above but with all cts
      bregmaFN7FullSeur, # seurat object of the 49142 cells in patches. Meta data has all major and neuronal cts
      bregmaFN7FullSeur_noNeuro, # 21652 non-neuronal cells also in patches
      simBregmasFN7, # list of bregma corpuses and gt for each bregma in FN7
      simBregmasFN7_neuro, # list of bregma corpuses and gt for each bregma in FN7_neuro
      simFN7, # same as `simBregmasFN7` but all combined into single "bregma" corpus
      simFN7_neuro, # same as `simBregmasFN7_neuro` but all combined into single "bregma" corpus. sim in both simFN7 and simFN7_neuro the same
      FN7_K8, # LDA model K=8 and trained on simFN7 (entire FN7 animal)
      FN7_K75, # LDA model K=75 and trained on simFN7 (entire FN7 animal)
      bregmaFN7FullSeur_markers8cts, # ct markers with Seurat::FindAllMarkers(object = bregmaFN7FullSeur
      bregmaFN7FullSeur_markers75neurocts, # ct markers with Seurat::FindAllMarkers(object = bregmaFN7FullSeur using all classes
      bregmaFN7FullSeur_noNeuro_markers, # ct markers with Seurat::FindAllMarkers(object = bregmaFN7FullSeur_noNeuro 6 major cts
      SL_bregmaFN7FullSeur8cts_fit, # SL deconvolve model using full `FN7`, `bregmaCellsGexpFN7`, and 8 major ct markers
      SL_bregmaFN7FullSeur75neurocts_fit, # SL deconvolve model using full `simFN7_neuro`, `bregmaCellsGexpFN7`, and 75 major ct markers
      RCTD_FN7_results_norm, # 3070 spots and 8 cts deconvolved with RCTD using bregmaCellsGexpFN7 ref with major classes
      RCTD_FN7_neuro_results_norm, # 3070 spots and 73 cts deconvolved with RCTD using bregmaCellsGexpFN7 ref with All classes
      SL_bregmaFN7FullSeur_noNeuro_fit, # SL deconvolve using `bregmaFN7FullSeur_noNeuro` (21652 cells) and noNeuro markers for 6 cts
      RCTD_FN7_noNeuro_results_norm, # 3070 spots and 6 cts deconvovled with RCTD using `bregmaFN7FullSeur_noNeuro` 
      file = "/Users/brendan/Desktop/PostDoc/work/STDeconvolve/repos/STdeconvolve/data/merfish_fitted_models.RData")

load("/Users/brendan/Desktop/PostDoc/work/STDeconvolve/repos/STdeconvolve/data/merfish_fitted_models.RData")

```

MERIGNUE differential genes for each cluster:
```{r}

# cells and their associated clusters
neuroClusters <- bregmaFN7FullSeur@meta.data$All_classes
names(neuroClusters) <- rownames(bregmaFN7FullSeur@meta.data)
# I-39 only has one cell so drop 
neuroClusters <- neuroClusters[which(!neuroClusters %in% c("I-39"))]
difGenesNeuro <- MERINGUE::getDifferentialGenes(cd = bregmaFN7FullSeur@assays$RNA@counts, cols = neuroClusters)

# cells and their associated clusters
majorClusters <- bregmaFN7FullSeur@meta.data$Major_class
names(majorClusters) <- rownames(bregmaFN7FullSeur@meta.data)
difGenesMajor <- MERINGUE::getDifferentialGenes(cd = bregmaFN7FullSeur@assays$RNA@counts, cols = majorClusters)

                                            
```

## Beta Pairing

## k=8 major cts

```{r}

m1 <- FN7_K8$beta
m2 <- as.matrix(gtCtGenesFN7)

sharedGenes <- intersect(colnames(m1), colnames(m2))

betaCor <- getCorrMtx(m1 = m1,
                      m2 = m2, # gt proxy beta
                      type = "b")

gplots::heatmap.2(x = betaCor,
                  # Rowv = NA, # to order topics based on pairs and not dendrogram
                  # Colv = NA,
                  density.info = "none",
                  trace = "none",
                  col = correlation_palette,
                  breaks = correlation_breaks,
                  key.xlab = "Correlation",
                  # xlab = "Predicted topics",
                  # ylab = "Major cell class",
                  key.title = NA,
                  cexRow = 1,
                  cexCol = 0.9,
                  # lhei = c(1,3),
                  margins = c(6,4))

pairs <- lsatPairs(betaCor)
gplots::heatmap.2(x = betaCor[pairs$rowix, pairs$colsix],
                  Rowv = NA, # to order topics based on pairs and not dendrogram
                  Colv = NA,
                  density.info = "none",
                  trace = "none",
                  col = correlation_palette,
                  breaks = correlation_breaks,
                  key.xlab = "Correlation",
                  # xlab = "Predicted topics",
                  # ylab = "Major cell class",
                  key.title = NA,
                  cexRow = 1,
                  cexCol = 0.9,
                  # lhei = c(1,3),
                  margins = c(6,4))

diag_cors <- diag(betaCor[pairs$rowix, pairs$colsix])

hist(diag_cors, breaks = 10)
mean(diag_cors)
sd(diag_cors)

```

How many microglia cells are there? Maybe if few, this is reason it doesn't correlate well? Cell proportions too low to have had a topic pick it up?

```{r}

# spot IDs
FN7_neuro_spotIDs <- unlist(lapply(keys(FN7_neuro), function(ix){
  # table to df
  rownames(FN7_neuro[[ix]]$cellTypeTable)
}))

# combine all the cellTypeTables of each bregma in FN7 (counts of each cell type in each spot)
FN7_neuro_cellTypeTable <- lapply(keys(FN7_neuro), function(ix){
  # table to df
  as.data.frame.matrix(FN7_neuro[[ix]]$cellTypeTable)
})
# combine into single df, and because some bregmas may be missing cell types,
# use rbindlist to keep all columns and add NAs to spots for cell types
# they are missing
FN7_neuro_cellTypeTable <- data.table::rbindlist(FN7_neuro_cellTypeTable, fill = TRUE)

# replace NAs with 0s
FN7_neuro_cellTypeTable[is.na(FN7_neuro_cellTypeTable)] <- 0

# spot IDs as row names
FN7_neuro_cellTypeTable <- as.matrix(FN7_neuro_cellTypeTable)
rownames(FN7_neuro_cellTypeTable) <- FN7_neuro_spotIDs

sort(colSums(FN7_neuro_cellTypeTable))

```

perictyes and microglia have smallest wrt the major cell types. 

```{r}

m1 <- FN7_K8$beta
m2 <- as.matrix(gtCtGenesFN7)

sharedGenes <- intersect(colnames(m1), colnames(m2))

corMtx <- getCorrMtx(m1 = m1,
                      m2 = m2,
                      type = "b")
pairs <- lsatPairs(corMtx)

summary_df <- do.call(rbind, lapply(pairs$rowix, function(i){
        # get paired ct
        ct <- rownames(m2)[pairs$colsix[i]]
        topic <- i
        
        # the corresponding diff genes table
        ct_df <- difGenesMajor[[ct]]
        
        # filter for sig diff genes for specific ct
        # ct_df <- ct_df[ct_df$p.adj < 0.05,]
        
        # ct sig genes that are also in corpus
        genes <- intersect(sharedGenes, rownames(ct_df))
        topic_betas <- m1[topic, genes]
        ct_df <- ct_df[genes,]
        
        # gexp values
        ct_genes <- m2[ct, genes]
        
        # add extra columns to df for ggplot
        ct_df$gexp <- ct_genes
        ct_df$gexp_rank <- rank(ct_genes)
        ct_df$beta <- topic_betas
        ct_df$beta_rank <- rank(topic_betas) # 1 = lowest beta
        ct_df$pair <- paste0(topic, " vs ", ct)
        
        # take top 10 betas
        # ct_df <- ct_df[ct_df$beta_rank > 83,]
         
        # x <- -log10(ct_df$p.adj)
        # x <- log10(ct_df$gexp + 1)
        x <- ct_df$gexp_rank
        # y <- ct_df$beta
        y <- ct_df$beta_rank
        # y <- ct_df$beta
         
        prsn <- cor(x, y, method = "pearson")
        sprn <- cor(x, y, method = "spearman")
        p <- ggplot(data = ct_df) +
                geom_point(aes(x = gexp_rank, y = beta_rank)) +
                labs(title = paste("Beta pairs: Topic", topic, "vs", ct, "; cor =", round(corMtx[topic, ct],2), "\n",
                                   "pearson =", round(prsn, 2), "spearman =", round(sprn, 2)))
        print(prsn)
        ct_df
})) 

ggplot(data = summary_df) +
        geom_hex(aes(x = gexp_rank, y = beta_rank), bins=10) +
        scale_fill_gradient(low = "white", high = "red") +
        theme_classic()

cor(summary_df$beta_rank, summary_df$gexp_rank, method = "spearman")

```

## k=75 all cts

```{r}

m1 <- FN7_K75$beta
m2 <- as.matrix(gtCtNeuronalGenesFN7)

sharedGenes <- intersect(colnames(m1), colnames(m2))

betaCor <- getCorrMtx(m1 = m1,
                      m2 = m2, # gt proxy beta
                      type = "b")

gplots::heatmap.2(x = betaCor,
                  # Rowv = NA, # to order topics based on pairs and not dendrogram
                  # Colv = NA,
                  density.info = "none",
                  trace = "none",
                  col = correlation_palette,
                  breaks = correlation_breaks,
                  key.xlab = "Correlation",
                  # xlab = "Predicted topics",
                  # ylab = "Major cell class",
                  key.title = NA,
                  cexRow = 1,
                  cexCol = 0.9,
                  # lhei = c(1,3),
                  margins = c(6,4))

pairs <- lsatPairs(betaCor)
gplots::heatmap.2(x = betaCor[pairs$rowix, pairs$colsix],
                  Rowv = NA, # to order topics based on pairs and not dendrogram
                  Colv = NA,
                  density.info = "none",
                  trace = "none",
                  col = correlation_palette,
                  breaks = correlation_breaks,
                  key.xlab = "Correlation",
                  # xlab = "Predicted topics",
                  # ylab = "Major cell class",
                  key.title = NA,
                  cexRow = 1,
                  cexCol = 0.9,
                  # lhei = c(1,3),
                  margins = c(6,4))

diag_cors <- diag(betaCor[pairs$rowix, pairs$colsix])

hist(diag_cors, breaks = 10)
mean(diag_cors)
sd(diag_cors)

```

```{r}

m1 <- FN7_K75$beta
m2 <- as.matrix(gtCtNeuronalGenesFN7) # drop I-39
m2 <- m2[rownames(m2) != "I-39",]

sharedGenes <- intersect(colnames(m1), colnames(m2))

corMtx <- getCorrMtx(m1 = m2,
                      m2 = m1,
                      type = "b")
pairs <- lsatPairs(corMtx)

summary_df <- do.call(rbind, lapply(pairs$rowix, function(i){
        # get paired ct and topic
        ct <- rownames(m2)[i]
        topic <- pairs$colsix[i]
        
        # the corresponding diff genes table
        ct_df <- difGenesNeuro[[ct]]
        
        # filter for sig diff genes for specific ct
        # ct_df <- ct_df[ct_df$p.adj < 0.05,]
        
        # ct sig genes that are also in corpus
        genes <- intersect(sharedGenes, rownames(ct_df))
        topic_betas <- m1[topic, genes]
        ct_df <- ct_df[genes,]
        
        # gexp values
        ct_genes <- m2[ct, genes]
        
        # add extra columns to df for ggplot
        ct_df$gexp <- ct_genes
        ct_df$gexp_rank <- rank(ct_genes)
        ct_df$beta <- topic_betas
        ct_df$beta_rank <- rank(topic_betas) # 1 = lowest beta
        ct_df$pair <- paste0(topic, " vs ", ct)
        
        # take top 10 betas
        # ct_df <- ct_df[ct_df$beta_rank > 83,]
         
        # x <- -log10(ct_df$p.adj)
        # x <- log10(ct_df$gexp + 1)
        x <- ct_df$gexp_rank
        # y <- ct_df$beta
        y <- ct_df$beta_rank
        # y <- ct_df$beta
         
        prsn <- cor(x, y, method = "pearson")
        sprn <- cor(x, y, method = "spearman")
        p <- ggplot(data = ct_df) +
                geom_point(aes(x = gexp_rank, y = beta_rank)) +
                labs(title = paste("Beta pairs: Topic", topic, "vs", ct, "; cor =", round(corMtx[ct,topic], 2), "\n",
                                   "pearson =", round(prsn, 2), "spearman =", round(sprn, 2)))
        print(prsn)
        ct_df
})) 

ggplot(data = summary_df) +
        geom_hex(aes(x = gexp_rank, y = beta_rank), bins=10) +
        scale_fill_gradient(low = "white", high = "red") +
        theme_classic()

cor(summary_df$beta_rank, summary_df$gexp_rank, method = "spearman")

```

## Selecting Betas

### k=8

```{r}

ggplot(data = reshape2::melt(FN7_K8$beta)) +
  geom_boxplot(aes(x = paste("Topic", Var1), y = value)) +
  labs(
       x = "Topic", y = "gene beta value") +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# ggplot(data = reshape2::melt(m1_filt)) +
#   geom_boxplot(aes(x = as.character(Var1), y = value)) +
#   geom_point(data = reshape2::melt(m1_filt)[which(reshape2::melt(m1_filt)[,"Var2"] == "Ptgds"),], 
#              aes(x = as.character(Var1), y = value, color = "red"))

```

**definition of outlier; interquant * 1.5 **

This is the distribution of beta values of the corpus genes for each topic. 
Idea is to select genes that are significantly higher than the distribution of beta values for a topic.

Another thought is whether the topic genes in a topic are distinct from the others or are there sets of genes that are enriched with high beta values for groups of topics? 

```{r}

# for each topic generate a PDF built off the gene betas for that topic.
# then for each gene, get it's p-val by integrating from the beta-value of the gene to the tail

topicGenePvals <- do.call(rbind, lapply(rownames(FN7_K8$beta), function(t){
  PDF <- approxfun(density(FN7_K8$beta[t,]), rule=2)
  # plot(PDF)
  pvals <- unlist(lapply(colnames(FN7_K8$beta), function(g){
    p <- integrate(PDF, lower=FN7_K8$beta[t,g], upper=1, stop.on.error = FALSE)
    p$value
  }))
  names(pvals) <- colnames(FN7_K8$beta)
  pvals
}))
rownames(topicGenePvals) <- rownames(FN7_K8$beta)


```

see the relationship between the p-val and beta value for genes in each topic

```{r}

topicSigGenes <- lapply(rownames(FN7_K8$beta), function(t) {
  plot(-log10(topicGenePvals[t,]), FN7_K8$beta[t,])
  plot(rank(topicGenePvals[t,]), rank(FN7_K8$beta[t,]))
  
  # print(-log10(topicGenePvals[t, which(-log10(topicGenePvals[t,]) > -log10(0.05))]))
  FN7_K8$beta[t, which(-log10(topicGenePvals[t,]) > -log10(0.05))]
})

```

In this case, maybe not the best method because topic 8, which is strongly correlated with OD, does not have any genes labels as significance, even though there is clearly a set of genes with high betas out of the entire set of 125 genes.

Rank is the same, but the p-value is not the same as the beta.

Selecting genes with p-vals < 0.05 yeilds approx 2-4 genes per topic that have the highest betas. Interestingly you do see some genes enriched for different groups of topics. It likely represents how the topics are related to each other in space and what cell layers and sub-layers they correspond to.

```{r}

table(names(unlist(topicSigGenes)))

```

just look at top 2 genes wrt beta value

```{r}

topGenes <- lapply(rownames(FN7_K8$beta), function(t){
  betas <- names(sort(FN7_K8$beta[t,], decreasing = TRUE)[1:3])
  betas
})
names(topGenes) <- rownames(FN7_K8$beta)

```

```{r, fig.height=8, fig.width=10}

names(topicSigGenes) <- rownames(FN7_K8$beta)

spots <- rownames(as.matrix(slam::as.simple_triplet_matrix(simFN7$sim))[1:1536,]) # first 6 bregmas
annotDf <- simFN7$annotDf[(simFN7$annotDf$patch_id %in% spots), ]
cells <- rownames(annotDf)
pos <- annotDf[,c("Centroid_X", "Centroid_Y")]; colnames(pos) <- c("x", "y")
mat <- bregmaCellsGexpFN7[cells,]

ggplot() +
  geom_point(data = annotDf,
             aes(x = Centroid_X, y = Centroid_Y, color = Cell_class), size=0.1) +
  facet_wrap(~Cell_class) +
  theme(
        #panel.background = element_rect(fill = "white"),
        panel.grid = element_blank(),
        axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_blank())

# pairing topics to cell types
m1 <- FN7_K8$beta
m2 <- as.matrix(gtCtGenesFN7)
sharedGenes <- intersect(colnames(m1), colnames(m2))
betaCor <- getCorrMtx(m1 = m1,
                      m2 = m2, # gt proxy beta
                      type = "b")
pairs <- lsatPairs(betaCor)

# generate plots
for (topic in seq(length(topGenes))){
        ct <- rownames(m2)[pairs$colsix[topic]]
        genes <- topGenes[[topic]]
        
        df <- mat[,genes]
        df <- merge(pos, as.data.frame(df), by=0)
        rownames(df) <- df$Row.names
        
        # cell_class <- annotDf$Cell_class
        # cell_class[cell_class != ct] <- 0
        # cell_class[cell_class == ct] <- 1
        
        for (gene in genes){
              vizGeneCounts(df = df,
              gene = gene,
              groups = NA,
              group_cols = NA,
              size = 0.5,
              stroke = 0.01,
              plotTitle = paste("topic =", topic, gene, "\n", "group =", ct),
              showLegend = TRUE)
              # ggsave(filename = paste0(topic, "_", gene, "_", ct, "_", "bregmas.pdf"),
              #        device = "pdf",
              #        path = fig_path,
              #        scale = 1.5,
              #        width = 5,
              #        height = 4,
              #        units = c("in"),
              #        dpi = 600)
        }
}

```















