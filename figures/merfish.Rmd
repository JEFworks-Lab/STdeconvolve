---
title: "Untitled"
author: "Brendan F. Miller"
date: "3/23/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

# all of the trained models for merfish:
save(bregmaCellsGexpFN7, # 59651 cells in FN7 bregmas x 125 gene counts (blanks removed and ambiguous cells removed)
      bregmaCellsGexpFN7_filt, # above but only cells kept in simulated patches (49142)
      gtCtGenesFN7, # reference for 8 major cell types and 125 genes. relative average expression. Used all 59651 cells
      gtCtNeuronalGenesFN7, # same as above but expanded into neuronal cts so 75 types
      FN7, # hash table storing each simulated bregma in FN7. Built such that cellTypeTable is for 8 major cts
      FN7_neuro, # same as above but with all cts
      bregmaFN7FullSeur, # seurat object of the 49142 cells in patches. Meta data has all major and neuronal cts
      bregmaFN7FullSeur_noNeuro, # 21652 non-neuronal cells also in patches
      simBregmasFN7, # list of bregma corpuses and gt for each bregma in FN7
      simBregmasFN7_neuro, # list of bregma corpuses and gt for each bregma in FN7_neuro
      simFN7, # same as `simBregmasFN7` but all combined into single "bregma" corpus
      simFN7_neuro, # same as `simBregmasFN7_neuro` but all combined into single "bregma" corpus. sim in both simFN7 and simFN7_neuro the same
      FN7_K8, # LDA model K=8 and trained on simFN7 (entire FN7 animal)
      FN7_K75, # LDA model K=75 and trained on simFN7 (entire FN7 animal)
      bregmaFN7FullSeur_markers8cts, # ct markers with Seurat::FindAllMarkers(object = bregmaFN7FullSeur
      bregmaFN7FullSeur_markers75neurocts, # ct markers with Seurat::FindAllMarkers(object = bregmaFN7FullSeur using all classes
      bregmaFN7FullSeur_noNeuro_markers, # ct markers with Seurat::FindAllMarkers(object = bregmaFN7FullSeur_noNeuro 6 major cts
      SL_bregmaFN7FullSeur8cts_fit, # SL deconvolve model using full `FN7`, `bregmaCellsGexpFN7`, and 8 major ct markers
      SL_bregmaFN7FullSeur75neurocts_fit, # SL deconvolve model using full `simFN7_neuro`, `bregmaCellsGexpFN7`, and 75 major ct markers
      RCTD_FN7_results_norm, # 3070 spots and 8 cts deconvolved with RCTD using bregmaCellsGexpFN7 ref with major classes
      RCTD_FN7_neuro_results_norm, # 3070 spots and 73 cts deconvolved with RCTD using bregmaCellsGexpFN7 ref with All classes
      SL_bregmaFN7FullSeur_noNeuro_fit, # SL deconvolve using `bregmaFN7FullSeur_noNeuro` (21652 cells) and noNeuro markers for 6 cts
      RCTD_FN7_noNeuro_results_norm, # 3070 spots and 6 cts deconvovled with RCTD using `bregmaFN7FullSeur_noNeuro` 
      file = "/Users/brendan/Desktop/PostDoc/work/STDeconvolve/repos/STdeconvolve/data/merfish_fitted_models.RData")

load("/Users/brendan/Desktop/PostDoc/work/STDeconvolve/repos/STdeconvolve/data/merfish_fitted_models.RData")

```

```{r}

fig_path <- "/Users/brendan/Desktop/PostDoc/work/STDeconvolve/repos/STdeconvolve/figures/"

```

MERIGNUE differential genes for each cluster:
```{r}

# cells and their associated clusters
neuroClusters <- bregmaFN7FullSeur@meta.data$All_classes
names(neuroClusters) <- rownames(bregmaFN7FullSeur@meta.data)
# I-39 only has one cell so drop 
neuroClusters <- neuroClusters[which(!neuroClusters %in% c("I-39"))]
difGenesNeuro <- MERINGUE::getDifferentialGenes(cd = bregmaFN7FullSeur@assays$RNA@counts, cols = neuroClusters)

# cells and their associated clusters
majorClusters <- bregmaFN7FullSeur@meta.data$Major_class
names(majorClusters) <- rownames(bregmaFN7FullSeur@meta.data)
difGenesMajor <- MERINGUE::getDifferentialGenes(cd = bregmaFN7FullSeur@assays$RNA@counts, cols = majorClusters)

                                            
```

```{r, fig.height=8, fig.width=10}

spots <- rownames(as.matrix(slam::as.simple_triplet_matrix(simFN7$sim))[1:1536,]) # first 6 bregmas
annotDf <- simFN7$annotDf[(simFN7$annotDf$patch_id %in% spots), ]
cells <- rownames(annotDf)
pos <- annotDf[,c("Centroid_X", "Centroid_Y")]; colnames(pos) <- c("x", "y")
mat <- bregmaCellsGexpFN7[cells,]

ggplot() +
  geom_point(data = annotDf,
             aes(x = Centroid_X, y = Centroid_Y, color = Cell_class), size=0.1) +
  facet_wrap(~Cell_class) +
  theme(
        #panel.background = element_rect(fill = "white"),
        panel.grid = element_blank(),
        axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_blank())

# pairing topics to cell types
m1 <- FN7_K8$beta
m2 <- as.matrix(gtCtGenesFN7)
sharedGenes <- intersect(colnames(m1), colnames(m2))
betaCor <- getCorrMtx(m1 = m1,
                      m2 = m2, # gt proxy beta
                      type = "b")
pairs <- lsatPairs(betaCor)

# generate plots
for (topic in seq(length(topGenes))){
        ct <- rownames(m2)[pairs$colsix[topic]]
        genes <- topGenes[[topic]]
        
        df <- mat[,genes]
        df <- merge(pos, as.data.frame(df), by=0)
        rownames(df) <- df$Row.names
        
        # cell_class <- annotDf$Cell_class
        # cell_class[cell_class != ct] <- 0
        # cell_class[cell_class == ct] <- 1
        
        for (gene in genes){
              vizGeneCounts(df = df,
              gene = gene,
              groups = NA,
              group_cols = NA,
              size = 0.5,
              stroke = 0.01,
              plotTitle = paste("topic =", topic, gene, "\n", "group =", ct),
              showLegend = TRUE)
              ggsave(filename = paste0(topic, "_", gene, "_", ct, "_", "bregmas.pdf"),
                     device = "pdf",
                     path = fig_path,
                     scale = 1.5,
                     width = 5,
                     height = 4,
                     units = c("in"),
                     dpi = 600)
        }
}

```

# RMSE

NOTE:
RMSE is scale dependent, and the value of RMSE is in relation to the actual variable being measured. So here it is ct proportions.

HOWEVER, each ct proportion is potentially on a different relative scale because some cts are more abundant in general than others.

So it may be important to scale the ct proportions relative to one another so that they can be compared.

This is likely why the rarer neuronalcts have lower unadjusted RMSEs when comparing to the higher proportion cell types but this is because each is on its own scale and units. THe RMSEs are in terms of the proportion of the cell type being considered!

## SL

### 8 cts

```{r}

breg_theta <- SL_bregmaFN7FullSeur8cts_fit[[2]][,1:ncol(SL_bregmaFN7FullSeur8cts_fit[[2]])-1]
breg_gt_theta <- as.matrix(simFN7$gtSpotTopics)

# make sure columns in each theta in same order
shared_cts <- intersect(colnames(breg_theta), colnames(breg_gt_theta))
truth_theta <- breg_gt_theta[,shared_cts]
predict_theta <- breg_theta[,shared_cts]

# make sure the rows are the same, too
# truth_theta <- truth_theta[rownames(predict_theta),]

# RMSE for each spot. Unadjusted ct proportions
raw_RMSE_sl_8cts_spots <- unlist(lapply(seq(dim(truth_theta)[1]), function(i){
  # for each spot, compute RMSE based on proportions across cts
  # so a RMSE for each spots based on all the cts
  actual <- as.vector(truth_theta[i,])
  predict <- as.vector(predict_theta[i,])
  mltools::rmse(preds = predict, actuals = actual)
}))

# RMSE for each ct. Unadjusted proportions
# return matrix where each column is the rmse for predicting a ct across the spots
raw_RMSE_sl_8cts <- do.call(cbind, lapply(colnames(truth_theta), function(ct){
  # for each ct, compare proportions across all the spots
  # so a RMSE for each ct
  mltools::rmse(preds = predict_theta[,ct], actuals = truth_theta[,ct])
}))
colnames(raw_RMSE_sl_8cts) <- colnames(truth_theta)

# ---------------------------------------------
# scale the ct proportions by dividing each by its sd
truth_theta <- scale(truth_theta, center = FALSE, scale = apply(truth_theta, 2, sd, na.rm = TRUE))
predict_theta <- scale(predict_theta, center = FALSE, scale = apply(predict_theta, 2, sd, na.rm = TRUE))

# RMSE for each spot. Unadjusted ct proportions
scaled_RMSE_sl_8cts_spots <- unlist(lapply(seq(dim(truth_theta)[1]), function(i){
  # for each spot, compute RMSE based on proportions across cts
  # so a RMSE for each spots based on all the cts
  actual <- as.vector(truth_theta[i,])
  predict <- as.vector(predict_theta[i,])
  mltools::rmse(preds = predict, actuals = actual)
}))

# RMSE for each ct. Unadjusted proportions
# return matrix where each column is the rmse for predicting a ct across the spots
scaled_RMSE_sl_8cts <- do.call(cbind, lapply(colnames(truth_theta), function(ct){
  # for each ct, compare proportions across all the spots
  # so a RMSE for each ct
  mltools::rmse(preds = predict_theta[,ct], actuals = truth_theta[,ct])
}))
colnames(scaled_RMSE_sl_8cts) <- colnames(truth_theta)

```

### 75 cts

```{r}

breg_theta <- SL_bregmaFN7FullSeur75neurocts_fit[[2]][,1:ncol(SL_bregmaFN7FullSeur75neurocts_fit[[2]])-1]
# fix column names so they match the gt
colnames(breg_theta) <- sub("\\.", "-", colnames(breg_theta))
breg_gt_theta <- as.matrix(simFN7_neuro$gtSpotTopics)

# make sure columns in each theta in same order
shared_cts <- intersect(colnames(breg_theta), colnames(breg_gt_theta))
truth_theta <- breg_gt_theta[,shared_cts]
predict_theta <- breg_theta[,shared_cts]

# make sure the rows are the same, too
# truth_theta <- truth_theta[rownames(predict_theta),]

# RMSE for each spot. Unadjusted ct proportions
raw_RMSE_sl_75cts_spots <- unlist(lapply(seq(dim(truth_theta)[1]), function(i){
  # for each spot, compute RMSE based on proportions across cts
  # so a RMSE for each spots based on all the cts
  actual <- as.vector(truth_theta[i,])
  predict <- as.vector(predict_theta[i,])
  mltools::rmse(preds = predict, actuals = actual)
}))

# RMSE for each ct. Unadjusted proportions
# return matrix where each column is the rmse for predicting a ct across the spots
raw_RMSE_sl_75cts <- do.call(cbind, lapply(colnames(truth_theta), function(ct){
  # for each ct, compare proportions across all the spots
  # so a RMSE for each ct
  mltools::rmse(preds = predict_theta[,ct], actuals = truth_theta[,ct])
}))
colnames(raw_RMSE_sl_75cts) <- colnames(truth_theta)

# ---------------------------------------------
# scale the ct proportions by dividing each by its sd
truth_theta <- scale(truth_theta, center = FALSE, scale = apply(truth_theta, 2, sd, na.rm = TRUE))
predict_theta <- scale(predict_theta, center = FALSE, scale = apply(predict_theta, 2, sd, na.rm = TRUE))

# RMSE for each spot. Unadjusted ct proportions
scaled_RMSE_sl_75cts_spots <- unlist(lapply(seq(dim(truth_theta)[1]), function(i){
  # for each spot, compute RMSE based on proportions across cts
  # so a RMSE for each spots based on all the cts
  actual <- as.vector(truth_theta[i,])
  predict <- as.vector(predict_theta[i,])
  mltools::rmse(preds = predict, actuals = actual)
}))

# RMSE for each ct. Unadjusted proportions
# return matrix where each column is the rmse for predicting a ct across the spots
scaled_RMSE_sl_75cts <- do.call(cbind, lapply(colnames(truth_theta), function(ct){
  # for each ct, compare proportions across all the spots
  # so a RMSE for each ct
  mltools::rmse(preds = predict_theta[,ct], actuals = truth_theta[,ct])
}))
colnames(scaled_RMSE_sl_75cts) <- colnames(truth_theta)

```

## RCTD

### 8 cts

```{r}

breg_theta <- RCTD_FN7_results_norm
breg_gt_theta <- as.matrix(simFN7$gtSpotTopics)

# make sure columns in each theta in same order
shared_cts <- intersect(colnames(breg_theta), colnames(breg_gt_theta))
truth_theta <- breg_gt_theta[,shared_cts]
predict_theta <- breg_theta[,shared_cts]

# make sure the rows are the same, too
truth_theta <- truth_theta[rownames(predict_theta),]

# RCTD has 3070 spots. 2 were dropped during deconvolution

# RMSE for each spot. Unadjusted ct proportions
raw_RMSE_rctd_8cts_spots <- unlist(lapply(seq(dim(truth_theta)[1]), function(i){
  # for each spot, compute RMSE based on proportions across cts
  # so a RMSE for each spots based on all the cts
  actual <- as.vector(truth_theta[i,])
  predict <- as.vector(predict_theta[i,])
  mltools::rmse(preds = predict, actuals = actual)
}))

# because missing spots for some reason, fill in by adding NAs
if (length(raw_RMSE_rctd_8cts_spots) < dim(breg_gt_theta)[1]){
  toFill <- dim(breg_gt_theta)[1] - length(raw_RMSE_rctd_8cts_spots)
  raw_RMSE_rctd_8cts_spots <- c(raw_RMSE_rctd_8cts_spots, rep(NA, toFill))
}

# RMSE for each ct. Unadjusted proportions
# return matrix where each column is the rmse for predicting a ct across the spots
raw_RMSE_rctd_8cts <- do.call(cbind, lapply(colnames(truth_theta), function(ct){
  # for each ct, compare proportions across all the spots
  # so a RMSE for each ct
  mltools::rmse(preds = predict_theta[,ct], actuals = truth_theta[,ct])
}))
colnames(raw_RMSE_rctd_8cts) <- colnames(truth_theta)

# ---------------------------------------------
# scale the ct proportions by dividing each by its sd
truth_theta <- scale(truth_theta, center = FALSE, scale = apply(truth_theta, 2, sd, na.rm = TRUE))
predict_theta <- scale(predict_theta, center = FALSE, scale = apply(predict_theta, 2, sd, na.rm = TRUE))

# RMSE for each spot. Unadjusted ct proportions
scaled_RMSE_rctd_8cts_spots <- unlist(lapply(seq(dim(truth_theta)[1]), function(i){
  # for each spot, compute RMSE based on proportions across cts
  # so a RMSE for each spots based on all the cts
  actual <- as.vector(truth_theta[i,])
  predict <- as.vector(predict_theta[i,])
  mltools::rmse(preds = predict, actuals = actual)
}))

# because missing spots for some reason, fill in by adding NAs
if (length(scaled_RMSE_rctd_8cts_spots) < dim(breg_gt_theta)[1]){
  toFill <- dim(breg_gt_theta)[1] - length(scaled_RMSE_rctd_8cts_spots)
  scaled_RMSE_rctd_8cts_spots <- c(scaled_RMSE_rctd_8cts_spots, rep(NA, toFill))
}

# RMSE for each ct. Unadjusted proportions
# return matrix where each column is the rmse for predicting a ct across the spots
scaled_RMSE_rctd_8cts <- do.call(cbind, lapply(colnames(truth_theta), function(ct){
  # for each ct, compare proportions across all the spots
  # so a RMSE for each ct
  mltools::rmse(preds = predict_theta[,ct], actuals = truth_theta[,ct])
}))
colnames(scaled_RMSE_rctd_8cts) <- colnames(truth_theta)

```

### 75 cts

```{r}

breg_theta <- RCTD_FN7_neuro_results_norm # 3070 and 73 cts
breg_gt_theta <- as.matrix(simFN7_neuro$gtSpotTopics)

# make sure columns in each theta in same order
shared_cts <- intersect(colnames(breg_theta), colnames(breg_gt_theta))
truth_theta <- breg_gt_theta[,shared_cts]
predict_theta <- breg_theta[,shared_cts]

# make sure the rows are the same, too
truth_theta <- truth_theta[rownames(predict_theta),]

# RCTD has 3070 spots. 2 were dropped during deconvolution

# RMSE for each spot. Unadjusted ct proportions
raw_RMSE_rctd_75cts_spots <- unlist(lapply(seq(dim(truth_theta)[1]), function(i){
  # for each spot, compute RMSE based on proportions across cts
  # so a RMSE for each spots based on all the cts
  actual <- as.vector(truth_theta[i,])
  predict <- as.vector(predict_theta[i,])
  mltools::rmse(preds = predict, actuals = actual)
}))

# because missing spots for some reason, fill in by adding NAs
if (length(raw_RMSE_rctd_75cts_spots) < dim(breg_gt_theta)[1]){
  toFill <- dim(breg_gt_theta)[1] - length(raw_RMSE_rctd_75cts_spots)
  raw_RMSE_rctd_75cts_spots <- c(raw_RMSE_rctd_75cts_spots, rep(NA, toFill))
}

# RMSE for each ct. Unadjusted proportions
# return matrix where each column is the rmse for predicting a ct across the spots
raw_RMSE_rctd_75cts <- do.call(cbind, lapply(colnames(truth_theta), function(ct){
  # for each ct, compare proportions across all the spots
  # so a RMSE for each ct
  mltools::rmse(preds = predict_theta[,ct], actuals = truth_theta[,ct])
}))
colnames(raw_RMSE_rctd_75cts) <- colnames(truth_theta)

# ---------------------------------------------
# scale the ct proportions by dividing each by its sd
truth_theta <- scale(truth_theta, center = FALSE, scale = apply(truth_theta, 2, sd, na.rm = TRUE))
predict_theta <- scale(predict_theta, center = FALSE, scale = apply(predict_theta, 2, sd, na.rm = TRUE))

# RMSE for each spot. Unadjusted ct proportions
scaled_RMSE_rctd_75cts_spots <- unlist(lapply(seq(dim(truth_theta)[1]), function(i){
  # for each spot, compute RMSE based on proportions across cts
  # so a RMSE for each spots based on all the cts
  actual <- as.vector(truth_theta[i,])
  predict <- as.vector(predict_theta[i,])
  mltools::rmse(preds = predict, actuals = actual)
}))

# because missing spots for some reason, fill in by adding NAs
if (length(scaled_RMSE_rctd_75cts_spots) < dim(breg_gt_theta)[1]){
  toFill <- dim(breg_gt_theta)[1] - length(scaled_RMSE_rctd_75cts_spots)
  scaled_RMSE_rctd_75cts_spots <- c(scaled_RMSE_rctd_75cts_spots, rep(NA, toFill))
}

# RMSE for each ct. Unadjusted proportions
# return matrix where each column is the rmse for predicting a ct across the spots
scaled_RMSE_rctd_75cts <- do.call(cbind, lapply(colnames(truth_theta), function(ct){
  # for each ct, compare proportions across all the spots
  # so a RMSE for each ct
  mltools::rmse(preds = predict_theta[,ct], actuals = truth_theta[,ct])
}))
colnames(scaled_RMSE_rctd_75cts) <- colnames(truth_theta)

```

## LDA

### 8 cts

```{r}

breg_theta <- FN7_K8$theta
breg_gt_theta <- as.matrix(simFN7$gtSpotTopics)

# get pairs of topics and ground truth cell types that correlate best
theta_pairs <- lsatPairs(getCorrMtx(m1 = breg_theta,
                                    m2 = breg_gt_theta,
                                    type = "t"))

# reorder the predicted topics to match their paired cell type
# rows are spots and columns are topics
# `pairs$rowix` are the new paired indices of the rows in the corrMtx. Here, the rows are the predicted topics
predict_theta <- breg_theta[,theta_pairs$rowix]
# the `pairs$rowix` are the new paired indices of the columns in the corrMtx. Here, the cols are the cell types
truth_theta <- breg_gt_theta[,theta_pairs$colsix]

# make sure the rows are the same, too
# truth_theta <- truth_theta[rownames(predict_theta),]

# RMSE for each spot. Unadjusted ct proportions
raw_RMSE_lda_8cts_spots <- unlist(lapply(seq(dim(truth_theta)[1]), function(i){
  # for each spot, compute RMSE based on proportions across cts
  # so a RMSE for each spots based on all the cts
  actual <- as.vector(truth_theta[i,])
  predict <- as.vector(predict_theta[i,])
  mltools::rmse(preds = predict, actuals = actual)
}))

# RMSE for each ct. Unadjusted proportions
# return matrix where each column is the rmse for predicting a ct across the spots

# columns reordered based on pairing
raw_RMSE_lda_8cts <- do.call(cbind, lapply(seq(ncol(truth_theta)), function(i){
  # for each ct, compare proportions across all the spots
  # so a RMSE for each ct
  mltools::rmse(preds = predict_theta[,i], actuals = truth_theta[,i])
}))
colnames(raw_RMSE_lda_8cts) <- colnames(truth_theta)

# ---------------------------------------------
# scale the ct proportions by dividing each by its sd
truth_theta <- scale(truth_theta, center = FALSE, scale = apply(truth_theta, 2, sd, na.rm = TRUE))
predict_theta <- scale(predict_theta, center = FALSE, scale = apply(predict_theta, 2, sd, na.rm = TRUE))

# RMSE for each spot. Unadjusted ct proportions
scaled_RMSE_lda_8cts_spots <- unlist(lapply(seq(dim(truth_theta)[1]), function(i){
  # for each spot, compute RMSE based on proportions across cts
  # so a RMSE for each spots based on all the cts
  actual <- as.vector(truth_theta[i,])
  predict <- as.vector(predict_theta[i,])
  mltools::rmse(preds = predict, actuals = actual)
}))

# RMSE for each ct. Unadjusted proportions
# return matrix where each column is the rmse for predicting a ct across the spots
scaled_RMSE_lda_8cts <- do.call(cbind, lapply(seq(ncol(truth_theta)), function(ct){
  # for each ct, compare proportions across all the spots
  # so a RMSE for each ct
  mltools::rmse(preds = predict_theta[,ct], actuals = truth_theta[,ct])
}))
colnames(scaled_RMSE_lda_8cts) <- colnames(truth_theta)

```

### 75 cts

```{r}

breg_theta <- FN7_K75$theta
breg_gt_theta <- as.matrix(simFN7_neuro$gtSpotTopics)

# get pairs of topics and ground truth cell types that correlate best
theta_pairs <- lsatPairs(getCorrMtx(m1 = breg_theta,
                                    m2 = breg_gt_theta,
                                    type = "t"))
# reorder the predicted topics to match their paired cell type
# rows are spots and columns are topics
# `pairs$rowix` are the new paired indices of the rows in the corrMtx. Here, the rows are the predicted topics
predict_theta <- breg_theta[,theta_pairs$rowix]
# the `pairs$rowix` are the new paired indices of the columns in the corrMtx. Here, the cols are the cell types
truth_theta <- breg_gt_theta[,theta_pairs$colsix]

# make sure the rows are the same, too
# truth_theta <- truth_theta[rownames(predict_theta),]

# RMSE for each spot. Unadjusted ct proportions
raw_RMSE_lda_75cts_spots <- unlist(lapply(seq(dim(truth_theta)[1]), function(i){
  # for each spot, compute RMSE based on proportions across cts
  # so a RMSE for each spots based on all the cts
  actual <- as.vector(truth_theta[i,])
  predict <- as.vector(predict_theta[i,])
  mltools::rmse(preds = predict, actuals = actual)
}))

# RMSE for each ct. Unadjusted proportions
# return matrix where each column is the rmse for predicting a ct across the spots
raw_RMSE_lda_75cts <- do.call(cbind, lapply(seq(ncol(truth_theta)), function(ct){
  # for each ct, compare proportions across all the spots
  # so a RMSE for each ct
  mltools::rmse(preds = predict_theta[,ct], actuals = truth_theta[,ct])
}))
colnames(raw_RMSE_lda_75cts) <- colnames(truth_theta)

# ---------------------------------------------
# scale the ct proportions by dividing each by its sd
truth_theta <- scale(truth_theta, center = FALSE, scale = apply(truth_theta, 2, sd, na.rm = TRUE))
predict_theta <- scale(predict_theta, center = FALSE, scale = apply(predict_theta, 2, sd, na.rm = TRUE))

# RMSE for each spot. Unadjusted ct proportions
scaled_RMSE_lda_75cts_spots <- unlist(lapply(seq(dim(truth_theta)[1]), function(i){
  # for each spot, compute RMSE based on proportions across cts
  # so a RMSE for each spots based on all the cts
  actual <- as.vector(truth_theta[i,])
  predict <- as.vector(predict_theta[i,])
  mltools::rmse(preds = predict, actuals = actual)
}))

# RMSE for each ct. Unadjusted proportions
# return matrix where each column is the rmse for predicting a ct across the spots
scaled_RMSE_lda_75cts <- do.call(cbind, lapply(seq(ncol(truth_theta)), function(ct){
  # for each ct, compare proportions across all the spots
  # so a RMSE for each ct
  mltools::rmse(preds = predict_theta[,ct], actuals = truth_theta[,ct])
}))
colnames(scaled_RMSE_lda_75cts) <- colnames(truth_theta)

```

## SL no neuronal cells

Because no neuronal cell, only 6 major cell types to consider. But set predictions of the "Excitatory" and "Inhibitory" to 0 and compare to the ground truth ref that has them. The idea is that they are there but the model didn't detect them.

```{r}

breg_theta <- SL_bregmaFN7FullSeur_noNeuro_fit[[2]][,1:ncol(SL_bregmaFN7FullSeur_noNeuro_fit[[2]])-1]
breg_gt_theta <- as.matrix(simFN7$gtSpotTopics)

# add in neuronal cts to predicted theta matrix
breg_theta <- cbind(breg_theta, rep(0,nrow(breg_theta)), rep(0,nrow(breg_theta)))
colnames(breg_theta)[7:8] <- c("Excitatory", "Inhibitory")

# make sure columns in each theta in same order
shared_cts <- intersect(colnames(breg_theta), colnames(breg_gt_theta))
truth_theta <- breg_gt_theta[,shared_cts]
predict_theta <- breg_theta[,shared_cts]

# make sure the rows are the same, too
# truth_theta <- truth_theta[rownames(predict_theta),]

# RMSE for each spot. Unadjusted ct proportions
raw_RMSE_sl_noNeur_8cts_spots <- unlist(lapply(seq(dim(truth_theta)[1]), function(i){
  # for each spot, compute RMSE based on proportions across cts
  # so a RMSE for each spots based on all the cts
  actual <- as.vector(truth_theta[i,])
  predict <- as.vector(predict_theta[i,])
  mltools::rmse(preds = predict, actuals = actual)
}))

# RMSE for each ct. Unadjusted proportions
# return matrix where each column is the rmse for predicting a ct across the spots
raw_RMSE_sl_noNeur_8cts <- do.call(cbind, lapply(colnames(truth_theta), function(ct){
  # for each ct, compare proportions across all the spots
  # so a RMSE for each ct
  mltools::rmse(preds = predict_theta[,ct], actuals = truth_theta[,ct])
}))
colnames(raw_RMSE_sl_noNeur_8cts) <- colnames(truth_theta)

# ---------------------------------------------
# scale the ct proportions by dividing each by its sd
truth_theta <- scale(truth_theta, center = FALSE, scale = apply(truth_theta, 2, sd, na.rm = TRUE))
predict_theta <- scale(predict_theta, center = FALSE, scale = apply(predict_theta, 2, sd, na.rm = TRUE))

# because all 0's for neuronal, returns NAs. Convert to 0
predict_theta[is.na(predict_theta)] <- 0

# RMSE for each spot. Unadjusted ct proportions
scaled_RMSE_sl_noNeur_8cts_spots <- unlist(lapply(seq(dim(truth_theta)[1]), function(i){
  # for each spot, compute RMSE based on proportions across cts
  # so a RMSE for each spots based on all the cts
  actual <- as.vector(truth_theta[i,])
  predict <- as.vector(predict_theta[i,])
  mltools::rmse(preds = predict, actuals = actual)
}))

# RMSE for each ct. Unadjusted proportions
# return matrix where each column is the rmse for predicting a ct across the spots
scaled_RMSE_sl_noNeur_8cts <- do.call(cbind, lapply(colnames(truth_theta), function(ct){
  # for each ct, compare proportions across all the spots
  # so a RMSE for each ct
  mltools::rmse(preds = predict_theta[,ct], actuals = truth_theta[,ct])
}))
colnames(scaled_RMSE_sl_noNeur_8cts) <- colnames(truth_theta)

```

## RCTD no neuronal cells

```{r}

breg_theta <- RCTD_FN7_noNeuro_results_norm
breg_gt_theta <- as.matrix(simFN7$gtSpotTopics)

# add in neuronal cts to predicted theta matrix
breg_theta <- cbind(breg_theta, rep(0,nrow(breg_theta)), rep(0,nrow(breg_theta)))
colnames(breg_theta)[7:8] <- c("Excitatory", "Inhibitory")

# make sure columns in each theta in same order
shared_cts <- intersect(colnames(breg_theta), colnames(breg_gt_theta))
truth_theta <- breg_gt_theta[,shared_cts]
predict_theta <- breg_theta[,shared_cts]

# make sure the rows are the same, too
truth_theta <- truth_theta[rownames(predict_theta),]

# RCTD has 3070 spots. 2 were dropped during deconvolution

# RMSE for each spot. Unadjusted ct proportions
raw_RMSE_rctd_noNeur_8cts_spots <- unlist(lapply(seq(dim(truth_theta)[1]), function(i){
  # for each spot, compute RMSE based on proportions across cts
  # so a RMSE for each spots based on all the cts
  actual <- as.vector(truth_theta[i,])
  predict <- as.vector(predict_theta[i,])
  mltools::rmse(preds = predict, actuals = actual)
}))

# because missing spots for some reason, fill in by adding NAs
if (length(raw_RMSE_rctd_noNeur_8cts_spots) < dim(breg_gt_theta)[1]){
  toFill <- dim(breg_gt_theta)[1] - length(raw_RMSE_rctd_noNeur_8cts_spots)
  raw_RMSE_rctd_noNeur_8cts_spots <- c(raw_RMSE_rctd_noNeur_8cts_spots, rep(NA, toFill))
}

# RMSE for each ct. Unadjusted proportions
# return matrix where each column is the rmse for predicting a ct across the spots
raw_RMSE_rctd_noNeur_8cts <- do.call(cbind, lapply(colnames(truth_theta), function(ct){
  # for each ct, compare proportions across all the spots
  # so a RMSE for each ct
  mltools::rmse(preds = predict_theta[,ct], actuals = truth_theta[,ct])
}))
colnames(raw_RMSE_rctd_noNeur_8cts) <- colnames(truth_theta)

# ---------------------------------------------
# scale the ct proportions by dividing each by its sd
truth_theta <- scale(truth_theta, center = FALSE, scale = apply(truth_theta, 2, sd, na.rm = TRUE))
predict_theta <- scale(predict_theta, center = FALSE, scale = apply(predict_theta, 2, sd, na.rm = TRUE))

# because all 0's for neuronal, returns NAs. Convert to 0
predict_theta[is.na(predict_theta)] <- 0

# RMSE for each spot. Unadjusted ct proportions
scaled_RMSE_rctd_noNeur_8cts_spots <- unlist(lapply(seq(dim(truth_theta)[1]), function(i){
  # for each spot, compute RMSE based on proportions across cts
  # so a RMSE for each spots based on all the cts
  actual <- as.vector(truth_theta[i,])
  predict <- as.vector(predict_theta[i,])
  mltools::rmse(preds = predict, actuals = actual)
}))

# because missing spots for some reason, fill in by adding NAs
if (length(scaled_RMSE_rctd_noNeur_8cts_spots) < dim(breg_gt_theta)[1]){
  toFill <- dim(breg_gt_theta)[1] - length(scaled_RMSE_rctd_noNeur_8cts_spots)
  scaled_RMSE_rctd_noNeur_8cts_spots <- c(scaled_RMSE_rctd_noNeur_8cts_spots, rep(NA, toFill))
}

# RMSE for each ct. Unadjusted proportions
# return matrix where each column is the rmse for predicting a ct across the spots
scaled_RMSE_rctd_noNeur_8cts <- do.call(cbind, lapply(colnames(truth_theta), function(ct){
  # for each ct, compare proportions across all the spots
  # so a RMSE for each ct
  mltools::rmse(preds = predict_theta[,ct], actuals = truth_theta[,ct])
}))
colnames(scaled_RMSE_rctd_noNeur_8cts) <- colnames(truth_theta)

```


## Compare across spots

Spots:
raw_RMSE_sl_8cts_spots
raw_RMSE_rctd_8cts_spots
raw_RMSE_lda_8cts_spots
raw_RMSE_sl_noNeur_8cts_spots
raw_RMSE_rctd_noNeur_8cts_spots

raw_RMSE_sl_75cts_spots
raw_RMSE_rctd_75cts_spots
raw_RMSE_lda_75cts_spots
raw_RMSE_sl_noNeur_8cts_spots
raw_RMSE_rctd_noNeur_8cts_spots

scaled_RMSE_sl_8cts_spots
scaled_RMSE_rctd_8cts_spots
scaled_RMSE_lda_8cts_spots
scaled_RMSE_sl_noNeur_8cts_spots
scaled_RMSE_rctd_noNeur_8cts_spots

scaled_RMSE_sl_75cts_spots
scaled_RMSE_rctd_75cts_spots
scaled_RMSE_lda_75cts_spots
scaled_RMSE_sl_noNeur_8cts_spots
scaled_RMSE_rctd_noNeur_8cts_spots

```{r}

raw_8cts <- data.frame("SPOTlight" = as.vector(raw_RMSE_sl_8cts_spots),
                        "RCTD" = as.vector(raw_RMSE_rctd_8cts_spots),
                        "STdeconvolve" = as.vector(raw_RMSE_lda_8cts_spots),
                        "SPOTlight noNeuro" = as.vector(raw_RMSE_sl_noNeur_8cts_spots),
                        "RCTD noNeuro" = as.vector(raw_RMSE_rctd_noNeur_8cts_spots))

ggplot(data = reshape2::melt(raw_8cts),
       aes(x = variable, y = value, fill = variable)) +
  geom_boxplot(outlier.shape=NA) +
  geom_point(position = position_jitterdodge(), alpha = 0.3, size = 0.1) + 
  labs(title = "MERFISH major cell type predictions in FN7 spots",
       x = "Method", y = "RMSE") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


scaled_8cts <- data.frame("SPOTlight" = as.vector(scaled_RMSE_sl_8cts_spots),
                        "RCTD" = as.vector(scaled_RMSE_rctd_8cts_spots),
                        "STdeconvolve" = as.vector(scaled_RMSE_lda_8cts_spots),
                        "SPOTlight noNeuro" = as.vector(scaled_RMSE_sl_noNeur_8cts_spots),
                        "RCTD noNeuro" = as.vector(scaled_RMSE_rctd_noNeur_8cts_spots))

ggplot(data = reshape2::melt(scaled_8cts),
       aes(x = variable, y = value, fill = variable)) +
  geom_boxplot(outlier.shape=NA) +
  geom_point(position = position_jitterdodge(), alpha = 0.3, size = 0.1) + 
  labs(title = "MERFISH major cell type predictions in FN7 spots",
       x = "Method", y = "Scaled RMSE") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


raw_75cts <- data.frame("SPOTlight" = as.vector(raw_RMSE_sl_75cts_spots),
                        "RCTD" = as.vector(raw_RMSE_rctd_75cts_spots),
                        "STdeconvolve" = as.vector(raw_RMSE_lda_75cts_spots),
                        "SPOTlight noNeuro" = as.vector(raw_RMSE_sl_noNeur_8cts_spots),
                        "RCTD noNeuro" = as.vector(raw_RMSE_rctd_noNeur_8cts_spots))

ggplot(data = reshape2::melt(raw_75cts),
       aes(x = variable, y = value, fill = variable)) +
  geom_boxplot(outlier.shape=NA) +
  geom_point(position = position_jitterdodge(), alpha = 0.3, size = 0.1) + 
  labs(title = "MERFISH all cell type predictions in FN7 spots",
       x = "Method", y = "RMSE") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

raw_75cts <- data.frame("SPOTlight" = as.vector(raw_RMSE_sl_75cts_spots),
                        "RCTD" = as.vector(raw_RMSE_rctd_75cts_spots),
                        "STdeconvolve" = as.vector(raw_RMSE_lda_75cts_spots))

ggplot(data = reshape2::melt(raw_75cts),
       aes(x = variable, y = value, fill = variable)) +
  geom_boxplot(outlier.shape=NA) +
  geom_point(position = position_jitterdodge(), alpha = 0.3, size = 0.1) + 
  labs(title = "MERFISH all cell type predictions in FN7 spots",
       x = "Method", y = "RMSE") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


scaled_75cts <- data.frame("SPOTlight" = as.vector(scaled_RMSE_sl_75cts_spots),
                        "RCTD" = as.vector(scaled_RMSE_rctd_75cts_spots),
                        "STdeconvolve" = as.vector(scaled_RMSE_lda_75cts_spots),
                        "SPOTlight noNeuro" = as.vector(scaled_RMSE_sl_noNeur_8cts_spots),
                        "RCTD noNeuro" = as.vector(scaled_RMSE_rctd_noNeur_8cts_spots))

ggplot(data = reshape2::melt(scaled_75cts),
       aes(x = variable, y = value, fill = variable)) +
  geom_boxplot(outlier.shape=NA) +
  geom_point(position = position_jitterdodge(), alpha = 0.3, size = 0.1) + 
  labs(title = "MERFISH all cell type predictions in FN7 spots",
       x = "Method", y = "Scaled RMSE") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


scaled_75cts <- data.frame("SPOTlight" = as.vector(scaled_RMSE_sl_75cts_spots),
                        "RCTD" = as.vector(scaled_RMSE_rctd_75cts_spots),
                        "STdeconvolve" = as.vector(scaled_RMSE_lda_75cts_spots))

ggplot(data = reshape2::melt(scaled_75cts),
       aes(x = variable, y = value, fill = variable)) +
  geom_boxplot(outlier.shape=NA) +
  geom_point(position = position_jitterdodge(), alpha = 0.3, size = 0.1) + 
  labs(title = "MERFISH all cell type predictions in FN7 spots",
       x = "Method", y = "Scaled RMSE") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

## Compare across cell types

cts:
raw_RMSE_sl_8cts
raw_RMSE_rctd_8cts
raw_RMSE_lda_8cts
raw_RMSE_sl_noNeur_8cts
raw_RMSE_rctd_noNeur_8cts

raw_RMSE_sl_75cts
raw_RMSE_rctd_75cts
raw_RMSE_lda_75cts
raw_RMSE_sl_noNeur_8cts
raw_RMSE_rctd_noNeur_8cts

scaled_RMSE_sl_8cts
scaled_RMSE_rctd_8cts
scaled_RMSE_lda_8cts
scaled_RMSE_sl_noNeur_8cts
scaled_RMSE_rctd_noNeur_8cts

scaled_RMSE_sl_75cts
scaled_RMSE_rctd_75cts
scaled_RMSE_lda_75cts
scaled_RMSE_sl_noNeur_8cts
scaled_RMSE_rctd_noNeur_8cts

### build summary dataframes

```{r}

# table of number of cell types in each spot for entire FN7

# spot IDs for all spots in FN7
FN7_spotIDs <- unlist(lapply(keys(FN7), function(ix){
  # table to df
  rownames(FN7[[ix]]$cellTypeTable)
}))

# combine all the cellTypeTables of each bregma in FN7 (counts of each cell type in each spot)
FN7_cellTypeTable <- lapply(keys(FN7), function(ix){
  # table to df
  as.data.frame.matrix(FN7[[ix]]$cellTypeTable)
})
# combine into single df, and because some bregmas may be missing cell types,
# use rbindlist to keep all columns and add NAs to spots for cell types
# they are missing
FN7_cellTypeTable <- data.table::rbindlist(FN7_cellTypeTable, fill = TRUE)

# replace NAs with 0s
FN7_cellTypeTable[is.na(FN7_cellTypeTable)] <- 0

# spot IDs as row names
FN7_cellTypeTable <- as.matrix(FN7_cellTypeTable)
rownames(FN7_cellTypeTable) <- FN7_spotIDs

```

```{r}

# for each cell type rmse across spots, build a dataframe that has the rmse as well as other info for the cell type.
# idea is to combine dataframes for each methods returned rmse for a cell type and then visualize
# the relationship between RMSE and cell type proportion. Compare across methods, cell types, other info, etc.

l_eachCt <- raw_RMSE_sl_8cts
cts <- labels(l_eachCt)[[2]]
rmses <- as.vector(l_eachCt)
# breg <- rep(ix, length(cts))
tool <- rep("SPOTlight", length(cts))
rmse_type <- rep("Raw", length(cts))
# total ct proportions
tot_p <- colSums(FN7_cellTypeTable)/sum(colSums(FN7_cellTypeTable))
proportion <- as.vector(tot_p[cts])
# max proportion in a spot
spot_max <- apply(simFN7$gtSpotTopics, 2, max)[cts]
# median proportion in a spot
spot_median <- apply(simFN7$gtSpotTopics, 2, median)[cts]
# sd proportion in a spot
spot_sd <- apply(simFN7$gtSpotTopics, 2, sd)[cts]

raw_RMSE_sl_8cts_df <- data.frame("Cell type" = cts,
                             "RMSE" = rmses,
                             # "Bregma" = breg,
                             "RMSE kind" = rmse_type,
                             "Method" = tool,
                             "Proportion" = proportion,
                             "Max spot proportion" = spot_max,
                             "Median spot proportion" = spot_median,
                             "Spot proportion std" = spot_sd)

l_eachCt <- raw_RMSE_rctd_8cts
cts <- labels(l_eachCt)[[2]]
rmses <- as.vector(l_eachCt)
# breg <- rep(ix, length(cts))
tool <- rep("RCTD", length(cts))
rmse_type <- rep("Raw", length(cts))
# total ct proportions
tot_p <- colSums(FN7_cellTypeTable)/sum(colSums(FN7_cellTypeTable))
proportion <- as.vector(tot_p[cts])
# max proportion in a spot
spot_max <- apply(simFN7$gtSpotTopics, 2, max)[cts]
# median proportion in a spot
spot_median <- apply(simFN7$gtSpotTopics, 2, median)[cts]
# sd proportion in a spot
spot_sd <- apply(simFN7$gtSpotTopics, 2, sd)[cts]

raw_RMSE_rctd_8cts_df <- data.frame("Cell type" = cts,
                             "RMSE" = rmses,
                             # "Bregma" = breg,
                             "RMSE kind" = rmse_type,
                             "Method" = tool,
                             "Proportion" = proportion,
                             "Max spot proportion" = spot_max,
                             "Median spot proportion" = spot_median,
                             "Spot proportion std" = spot_sd)

l_eachCt <- raw_RMSE_lda_8cts
cts <- labels(l_eachCt)[[2]]
rmses <- as.vector(l_eachCt)
# breg <- rep(ix, length(cts))
tool <- rep("STDeconvolve", length(cts))
rmse_type <- rep("Raw", length(cts))
# total ct proportions
tot_p <- colSums(FN7_cellTypeTable)/sum(colSums(FN7_cellTypeTable))
proportion <- as.vector(tot_p[cts])
# max proportion in a spot
spot_max <- apply(simFN7$gtSpotTopics, 2, max)[cts]
# median proportion in a spot
spot_median <- apply(simFN7$gtSpotTopics, 2, median)[cts]
# sd proportion in a spot
spot_sd <- apply(simFN7$gtSpotTopics, 2, sd)[cts]

raw_RMSE_lda_8cts_df <- data.frame("Cell type" = cts,
                             "RMSE" = rmses,
                             # "Bregma" = breg,
                             "RMSE kind" = rmse_type,
                             "Method" = tool,
                             "Proportion" = proportion,
                             "Max spot proportion" = spot_max,
                             "Median spot proportion" = spot_median,
                             "Spot proportion std" = spot_sd)

l_eachCt <- raw_RMSE_sl_noNeur_8cts
cts <- labels(l_eachCt)[[2]]
rmses <- as.vector(l_eachCt)
# breg <- rep(ix, length(cts))
tool <- rep("SPOTlight No Neuro", length(cts))
rmse_type <- rep("Raw", length(cts))
# total ct proportions
tot_p <- colSums(FN7_cellTypeTable)/sum(colSums(FN7_cellTypeTable))
proportion <- as.vector(tot_p[cts])
# max proportion in a spot
spot_max <- apply(simFN7$gtSpotTopics, 2, max)[cts]
# median proportion in a spot
spot_median <- apply(simFN7$gtSpotTopics, 2, median)[cts]
# sd proportion in a spot
spot_sd <- apply(simFN7$gtSpotTopics, 2, sd)[cts]

raw_RMSE_sl_noNeur_8cts_df <- data.frame("Cell type" = cts,
                             "RMSE" = rmses,
                             # "Bregma" = breg,
                             "RMSE kind" = rmse_type,
                             "Method" = tool,
                             "Proportion" = proportion,
                             "Max spot proportion" = spot_max,
                             "Median spot proportion" = spot_median,
                             "Spot proportion std" = spot_sd)

l_eachCt <- raw_RMSE_rctd_noNeur_8cts
cts <- labels(l_eachCt)[[2]]
rmses <- as.vector(l_eachCt)
# breg <- rep(ix, length(cts))
tool <- rep("RCTD No Neuro", length(cts))
rmse_type <- rep("Raw", length(cts))
# total ct proportions
tot_p <- colSums(FN7_cellTypeTable)/sum(colSums(FN7_cellTypeTable))
proportion <- as.vector(tot_p[cts])
# max proportion in a spot
spot_max <- apply(simFN7$gtSpotTopics, 2, max)[cts]
# median proportion in a spot
spot_median <- apply(simFN7$gtSpotTopics, 2, median)[cts]
# sd proportion in a spot
spot_sd <- apply(simFN7$gtSpotTopics, 2, sd)[cts]

raw_RMSE_rctd_noNeur_8cts_df <- data.frame("Cell type" = cts,
                             "RMSE" = rmses,
                             # "Bregma" = breg,
                             "RMSE kind" = rmse_type,
                             "Method" = tool,
                             "Proportion" = proportion,
                             "Max spot proportion" = spot_max,
                             "Median spot proportion" = spot_median,
                             "Spot proportion std" = spot_sd)



# now combine them all:
k8_raw_ct_rmse_summary <- do.call("rbind", list(raw_RMSE_sl_8cts_df,
                                                  raw_RMSE_rctd_8cts_df,
                                                  raw_RMSE_lda_8cts_df,
                                                  raw_RMSE_sl_noNeur_8cts_df,
                                                  raw_RMSE_rctd_noNeur_8cts_df))

```

```{r}

l_eachCt <- scaled_RMSE_sl_8cts
cts <- labels(l_eachCt)[[2]]
rmses <- as.vector(l_eachCt)
# breg <- rep(ix, length(cts))
tool <- rep("SPOTlight", length(cts))
rmse_type <- rep("Scaled", length(cts))
# total ct proportions
tot_p <- colSums(FN7_cellTypeTable)/sum(colSums(FN7_cellTypeTable))
proportion <- as.vector(tot_p[cts])
# max proportion in a spot
spot_max <- apply(simFN7$gtSpotTopics, 2, max)[cts]
# median proportion in a spot
spot_median <- apply(simFN7$gtSpotTopics, 2, median)[cts]
# sd proportion in a spot
spot_sd <- apply(simFN7$gtSpotTopics, 2, sd)[cts]

scaled_RMSE_sl_8cts_df <- data.frame("Cell type" = cts,
                             "RMSE" = rmses,
                             # "Bregma" = breg,
                             "RMSE kind" = rmse_type,
                             "Method" = tool,
                             "Proportion" = proportion,
                             "Max spot proportion" = spot_max,
                             "Median spot proportion" = spot_median,
                             "Spot proportion std" = spot_sd)

l_eachCt <- scaled_RMSE_rctd_8cts
cts <- labels(l_eachCt)[[2]]
rmses <- as.vector(l_eachCt)
# breg <- rep(ix, length(cts))
tool <- rep("RCTD", length(cts))
rmse_type <- rep("Scaled", length(cts))
# total ct proportions
tot_p <- colSums(FN7_cellTypeTable)/sum(colSums(FN7_cellTypeTable))
proportion <- as.vector(tot_p[cts])
# max proportion in a spot
spot_max <- apply(simFN7$gtSpotTopics, 2, max)[cts]
# median proportion in a spot
spot_median <- apply(simFN7$gtSpotTopics, 2, median)[cts]
# sd proportion in a spot
spot_sd <- apply(simFN7$gtSpotTopics, 2, sd)[cts]

scaled_RMSE_rctd_8cts_df <- data.frame("Cell type" = cts,
                             "RMSE" = rmses,
                             # "Bregma" = breg,
                             "RMSE kind" = rmse_type,
                             "Method" = tool,
                             "Proportion" = proportion,
                             "Max spot proportion" = spot_max,
                             "Median spot proportion" = spot_median,
                             "Spot proportion std" = spot_sd)

l_eachCt <- scaled_RMSE_lda_8cts
cts <- labels(l_eachCt)[[2]]
rmses <- as.vector(l_eachCt)
# breg <- rep(ix, length(cts))
tool <- rep("STDeconvolve", length(cts))
rmse_type <- rep("Scaled", length(cts))
# total ct proportions
tot_p <- colSums(FN7_cellTypeTable)/sum(colSums(FN7_cellTypeTable))
proportion <- as.vector(tot_p[cts])
# max proportion in a spot
spot_max <- apply(simFN7$gtSpotTopics, 2, max)[cts]
# median proportion in a spot
spot_median <- apply(simFN7$gtSpotTopics, 2, median)[cts]
# sd proportion in a spot
spot_sd <- apply(simFN7$gtSpotTopics, 2, sd)[cts]

scaled_RMSE_lda_8cts_df <- data.frame("Cell type" = cts,
                             "RMSE" = rmses,
                             # "Bregma" = breg,
                             "RMSE kind" = rmse_type,
                             "Method" = tool,
                             "Proportion" = proportion,
                             "Max spot proportion" = spot_max,
                             "Median spot proportion" = spot_median,
                             "Spot proportion std" = spot_sd)

l_eachCt <- scaled_RMSE_sl_noNeur_8cts
cts <- labels(l_eachCt)[[2]]
rmses <- as.vector(l_eachCt)
# breg <- rep(ix, length(cts))
tool <- rep("SPOTlight No Neuro", length(cts))
rmse_type <- rep("Scaled", length(cts))
# total ct proportions
tot_p <- colSums(FN7_cellTypeTable)/sum(colSums(FN7_cellTypeTable))
proportion <- as.vector(tot_p[cts])
# max proportion in a spot
spot_max <- apply(simFN7$gtSpotTopics, 2, max)[cts]
# median proportion in a spot
spot_median <- apply(simFN7$gtSpotTopics, 2, median)[cts]
# sd proportion in a spot
spot_sd <- apply(simFN7$gtSpotTopics, 2, sd)[cts]

scaled_RMSE_sl_noNeur_8cts_df <- data.frame("Cell type" = cts,
                             "RMSE" = rmses,
                             # "Bregma" = breg,
                             "RMSE kind" = rmse_type,
                             "Method" = tool,
                             "Proportion" = proportion,
                             "Max spot proportion" = spot_max,
                             "Median spot proportion" = spot_median,
                             "Spot proportion std" = spot_sd)

l_eachCt <- scaled_RMSE_rctd_noNeur_8cts
cts <- labels(l_eachCt)[[2]]
rmses <- as.vector(l_eachCt)
# breg <- rep(ix, length(cts))
tool <- rep("RCTD No Neuro", length(cts))
rmse_type <- rep("Scaled", length(cts))
# total ct proportions
tot_p <- colSums(FN7_cellTypeTable)/sum(colSums(FN7_cellTypeTable))
proportion <- as.vector(tot_p[cts])
# max proportion in a spot
spot_max <- apply(simFN7$gtSpotTopics, 2, max)[cts]
# median proportion in a spot
spot_median <- apply(simFN7$gtSpotTopics, 2, median)[cts]
# sd proportion in a spot
spot_sd <- apply(simFN7$gtSpotTopics, 2, sd)[cts]

scaled_RMSE_rctd_noNeur_8cts_df <- data.frame("Cell type" = cts,
                             "RMSE" = rmses,
                             # "Bregma" = breg,
                             "RMSE kind" = rmse_type,
                             "Method" = tool,
                             "Proportion" = proportion,
                             "Max spot proportion" = spot_max,
                             "Median spot proportion" = spot_median,
                             "Spot proportion std" = spot_sd)



# now combine them all:
k8_scaled_ct_rmse_summary <- do.call("rbind", list(scaled_RMSE_sl_8cts_df,
                                                  scaled_RMSE_rctd_8cts_df,
                                                  scaled_RMSE_lda_8cts_df,
                                                  scaled_RMSE_sl_noNeur_8cts_df,
                                                  scaled_RMSE_rctd_noNeur_8cts_df))

```

```{r}

# spot IDs
FN7_neuro_spotIDs <- unlist(lapply(keys(FN7_neuro), function(ix){
  # table to df
  rownames(FN7_neuro[[ix]]$cellTypeTable)
}))

# combine all the cellTypeTables of each bregma in FN7 (counts of each cell type in each spot)
FN7_neuro_cellTypeTable <- lapply(keys(FN7_neuro), function(ix){
  # table to df
  as.data.frame.matrix(FN7_neuro[[ix]]$cellTypeTable)
})
# combine into single df, and because some bregmas may be missing cell types,
# use rbindlist to keep all columns and add NAs to spots for cell types
# they are missing
FN7_neuro_cellTypeTable <- data.table::rbindlist(FN7_neuro_cellTypeTable, fill = TRUE)

# replace NAs with 0s
FN7_neuro_cellTypeTable[is.na(FN7_neuro_cellTypeTable)] <- 0

# spot IDs as row names
FN7_neuro_cellTypeTable <- as.matrix(FN7_neuro_cellTypeTable)
rownames(FN7_neuro_cellTypeTable) <- FN7_neuro_spotIDs

```

```{r}

l_eachCt <- raw_RMSE_sl_75cts
cts <- labels(l_eachCt)[[2]]
rmses <- as.vector(l_eachCt)
# breg <- rep(ix, length(cts))
tool <- rep("SPOTlight all cts", length(cts))
rmse_type <- rep("Raw", length(cts))
# total ct proportions
tot_p <- colSums(FN7_neuro_cellTypeTable)/sum(colSums(FN7_neuro_cellTypeTable))
proportion <- as.vector(tot_p[cts])
# max proportion in a spot
spot_max <- apply(simFN7_neuro$gtSpotTopics, 2, max)[cts]
# median proportion in a spot
spot_median <- apply(simFN7_neuro$gtSpotTopics, 2, median)[cts]
# sd proportion in a spot
spot_sd <- apply(simFN7_neuro$gtSpotTopics, 2, sd)[cts]

raw_RMSE_sl_75cts_df <- data.frame("Cell type" = cts,
                             "RMSE" = rmses,
                             # "Bregma" = breg,
                             "RMSE kind" = rmse_type,
                             "Method" = tool,
                             "Proportion" = proportion,
                             "Max spot proportion" = spot_max,
                             "Median spot proportion" = spot_median,
                             "Spot proportion std" = spot_sd)

l_eachCt <- raw_RMSE_rctd_75cts
cts <- labels(l_eachCt)[[2]]
rmses <- as.vector(l_eachCt)
# breg <- rep(ix, length(cts))
tool <- rep("RCTD all cts", length(cts))
rmse_type <- rep("Raw", length(cts))
# total ct proportions
tot_p <- colSums(FN7_neuro_cellTypeTable)/sum(colSums(FN7_neuro_cellTypeTable))
proportion <- as.vector(tot_p[cts])
# max proportion in a spot
spot_max <- apply(simFN7_neuro$gtSpotTopics, 2, max)[cts]
# median proportion in a spot
spot_median <- apply(simFN7_neuro$gtSpotTopics, 2, median)[cts]
# sd proportion in a spot
spot_sd <- apply(simFN7_neuro$gtSpotTopics, 2, sd)[cts]

raw_RMSE_rctd_75cts_df <- data.frame("Cell type" = cts,
                             "RMSE" = rmses,
                             # "Bregma" = breg,
                             "RMSE kind" = rmse_type,
                             "Method" = tool,
                             "Proportion" = proportion,
                             "Max spot proportion" = spot_max,
                             "Median spot proportion" = spot_median,
                             "Spot proportion std" = spot_sd)

l_eachCt <- raw_RMSE_lda_75cts
cts <- labels(l_eachCt)[[2]]
rmses <- as.vector(l_eachCt)
# breg <- rep(ix, length(cts))
tool <- rep("LDA all cts", length(cts))
rmse_type <- rep("Raw", length(cts))
# total ct proportions
tot_p <- colSums(FN7_neuro_cellTypeTable)/sum(colSums(FN7_neuro_cellTypeTable))
proportion <- as.vector(tot_p[cts])
# max proportion in a spot
spot_max <- apply(simFN7_neuro$gtSpotTopics, 2, max)[cts]
# median proportion in a spot
spot_median <- apply(simFN7_neuro$gtSpotTopics, 2, median)[cts]
# sd proportion in a spot
spot_sd <- apply(simFN7_neuro$gtSpotTopics, 2, sd)[cts]

raw_RMSE_lda_75cts_df <- data.frame("Cell type" = cts,
                             "RMSE" = rmses,
                             # "Bregma" = breg,
                             "RMSE kind" = rmse_type,
                             "Method" = tool,
                             "Proportion" = proportion,
                             "Max spot proportion" = spot_max,
                             "Median spot proportion" = spot_median,
                             "Spot proportion std" = spot_sd)

# now combine them all:
k75_raw_ct_rmse_summary <- do.call("rbind", list(raw_RMSE_sl_75cts_df,
                                                  raw_RMSE_rctd_75cts_df,
                                                  raw_RMSE_lda_75cts_df))

```

```{r}

l_eachCt <- scaled_RMSE_sl_75cts
cts <- labels(l_eachCt)[[2]]
rmses <- as.vector(l_eachCt)
# breg <- rep(ix, length(cts))
tool <- rep("SPOTlight all cts", length(cts))
rmse_type <- rep("Scaled", length(cts))
# total ct proportions
tot_p <- colSums(FN7_neuro_cellTypeTable)/sum(colSums(FN7_neuro_cellTypeTable))
proportion <- as.vector(tot_p[cts])
# max proportion in a spot
spot_max <- apply(simFN7_neuro$gtSpotTopics, 2, max)[cts]
# median proportion in a spot
spot_median <- apply(simFN7_neuro$gtSpotTopics, 2, median)[cts]
# sd proportion in a spot
spot_sd <- apply(simFN7_neuro$gtSpotTopics, 2, sd)[cts]

scaled_RMSE_sl_75cts_df <- data.frame("Cell type" = cts,
                             "RMSE" = rmses,
                             # "Bregma" = breg,
                             "RMSE kind" = rmse_type,
                             "Method" = tool,
                             "Proportion" = proportion,
                             "Max spot proportion" = spot_max,
                             "Median spot proportion" = spot_median,
                             "Spot proportion std" = spot_sd)

l_eachCt <- scaled_RMSE_rctd_75cts
cts <- labels(l_eachCt)[[2]]
rmses <- as.vector(l_eachCt)
# breg <- rep(ix, length(cts))
tool <- rep("RCTD all cts", length(cts))
rmse_type <- rep("Scaled", length(cts))
# total ct proportions
tot_p <- colSums(FN7_neuro_cellTypeTable)/sum(colSums(FN7_neuro_cellTypeTable))
proportion <- as.vector(tot_p[cts])
# max proportion in a spot
spot_max <- apply(simFN7_neuro$gtSpotTopics, 2, max)[cts]
# median proportion in a spot
spot_median <- apply(simFN7_neuro$gtSpotTopics, 2, median)[cts]
# sd proportion in a spot
spot_sd <- apply(simFN7_neuro$gtSpotTopics, 2, sd)[cts]

scaled_RMSE_rctd_75cts_df <- data.frame("Cell type" = cts,
                             "RMSE" = rmses,
                             # "Bregma" = breg,
                             "RMSE kind" = rmse_type,
                             "Method" = tool,
                             "Proportion" = proportion,
                             "Max spot proportion" = spot_max,
                             "Median spot proportion" = spot_median,
                             "Spot proportion std" = spot_sd)

l_eachCt <- scaled_RMSE_lda_75cts
cts <- labels(l_eachCt)[[2]]
rmses <- as.vector(l_eachCt)
# breg <- rep(ix, length(cts))
tool <- rep("LDA all cts", length(cts))
rmse_type <- rep("Scaled", length(cts))
# total ct proportions
tot_p <- colSums(FN7_neuro_cellTypeTable)/sum(colSums(FN7_neuro_cellTypeTable))
proportion <- as.vector(tot_p[cts])
# max proportion in a spot
spot_max <- apply(simFN7_neuro$gtSpotTopics, 2, max)[cts]
# median proportion in a spot
spot_median <- apply(simFN7_neuro$gtSpotTopics, 2, median)[cts]
# sd proportion in a spot
spot_sd <- apply(simFN7_neuro$gtSpotTopics, 2, sd)[cts]

scaled_RMSE_lda_75cts_df <- data.frame("Cell type" = cts,
                             "RMSE" = rmses,
                             # "Bregma" = breg,
                             "RMSE kind" = rmse_type,
                             "Method" = tool,
                             "Proportion" = proportion,
                             "Max spot proportion" = spot_max,
                             "Median spot proportion" = spot_median,
                             "Spot proportion std" = spot_sd)

# now combine them all:
k75_scaled_ct_rmse_summary <- do.call("rbind", list(scaled_RMSE_sl_75cts_df,
                                                  scaled_RMSE_rctd_75cts_df,
                                                  scaled_RMSE_lda_75cts_df))

```

### visualize

k8_raw_ct_rmse_summary
k8_scaled_ct_rmse_summary
k75_raw_ct_rmse_summary
k75_scaled_ct_rmse_summary

```{r, fig.height=4, fig.width=10}

ggplot(data = k8_raw_ct_rmse_summary, aes(x = Method, y = RMSE)) +
  # geom_boxplot(position = position_dodge(1)) +
  # geom_point(position = position_jitterdodge()) +
  geom_point() +
  facet_wrap(~Cell.type, ncol = 6) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title = "MERFISH 8 Major cell type predictions by method",
       x = "Method", y = "RMSE")

```

The RMSE above is the proportion for each cell type. In general could compare ct to ct but note that for some cts that have lower proportions overall like OD and pericytes, the RMSE not really comparable because it will be lower as their proportion is lower.

Microglia is the one major CT where LDA has some trouble compared to the other methods. LDA does better for Excitatory than other methods. Removal of Neuronal cells causes RCTD to struggle with Astrocytes. SPOTlight also has trouble with Microglia.

```{r, fig.height=16, fig.width=10}

ggplot(data = k75_raw_ct_rmse_summary, aes(x = Method, y = RMSE)) +
  # geom_boxplot(position = position_dodge(1)) +
  # geom_point(position = position_jitterdodge()) +
  geom_point() +
  facet_wrap(~Cell.type, ncol = 6) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title = "MERFISH all cell type predictions by method",
       x = "Method", y = "RMSE")

```

Looking closer, SPOTlight also does worse with ODs. LDA does well for Inhibatory subtypes - sometimes better than RCTD and SPOTlight

```{r, fig.height=6, fig.width=12}

ggplot(data = k8_raw_ct_rmse_summary, aes(x = Proportion, y = RMSE, color = Cell.type)) +
  geom_point() +
  facet_wrap(~Method) +
  theme_classic() +
  labs(title = "MERFISH major cell type predictions by method", y = "RMSE")

ggplot(data = k8_scaled_ct_rmse_summary, aes(x = Proportion, y = RMSE, color = Cell.type)) +
  geom_point() +
  facet_wrap(~Method) +
  theme_classic() +
  labs(title = "MERFISH major cell type predictions by method", y = "Scaled RMSE")

```

STdeconvolve and SPOTlight in general do worse for cts at overall lower proportions.

```{r, fig.height=6, fig.width=16}

ggplot(data = k75_raw_ct_rmse_summary, aes(x = Proportion, y = RMSE, color = Cell.type)) +
  geom_point() +
  facet_wrap(~Method) +
  theme_classic() +
  labs(title = "MERFISH all cell type predictions by method", y = "RMSE")

ggplot(data = k75_scaled_ct_rmse_summary, aes(x = Proportion, y = RMSE, color = Cell.type)) +
  geom_point() +
  facet_wrap(~Method) +
  theme_classic() +
  labs(title = "MERFISH all cell type predictions by method", y = "Scaled RMSE")

```

In general the trend is that at higher proportions each method has an easier time deconvolving cell types. But for rare neuronal subtypes, it is highly variable depending on subtype. Might be because the MERFISH genes were marker genes so in theory should be able to ID the subtypes. Of course some are probably similar and thus become more difficult to ID.






